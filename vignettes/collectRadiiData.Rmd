---
title: "Collect radial measurements from a calcified structure by interactively selecting annuli"
author: "Derek H. Ogle"
date: "`r Sys.Date()`"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: vignette
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Collect radial measurements from a calcified structure by interactively selecting annuli}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r eval=FALSE, echo=FALSE}
## Run this code to actually build the vignette for the package
devtools::build_vignettes()
devtools::install()
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction
The size of fish at a previous time in their life is often estimated through a method called "back-calculation".[^1] Back-calculation of previous lengths requires accurate measurements of annual growth on calcified structures (hereafter, structures) extracted from individual fish and a suitable model that relates growth on the structure to growth of the fish. The [FishBC software](https://fisheries.org/bookstore/all-titles/software/70317/) is commonly used to measure lengths on the structure and apply a back-calculation model to estimate size at a previous age. This `RFishBC` package was developed to replicate the functionality of the FishBC software because FishBC only works on out-dated computers, there are no plans to update it, and it is not open source. Methods for making measurements on structure images is demonstrated in this vignette. Using those measurements to back-calculate fish length at a previous age is demonstrated in [this separate vignette](backcalculation.html).

This vignette assumes that you have a basic understand of back-calculation and the data (especially radial measurements made to annuli on a calcified structure) required to make back-calculations.

The methods described in this vignette require the following packages.

```{r message=FALSE}
library(RFishBC)
library(dplyr)    # for mutate(), inner_join()
```

\  

\  

----

# Collect Radii Data
The `collectRadiiData()` function is used to

1. Load an image (JPG, PNG, or BMP) of a structure.
1. Optionally provide a scaling for the image.
1. Optionally add a transect to that image to aid selecting annuli.
1. Interactively select annuli on the structure image.
1. Create an R data object file (i.e., ".Rdata" file) that contains, among other things, the radial measurements between the selected annuli.

For example (*but described thoroughly further below*), the line below loads the structure image in "Scale_1.png" (found in the current working directory), asks the user to add a linear transect (this is default behavior), asks the user to select points that represent annuli (noting that the edge is not considered to be an annulus; this is default behavior), identifies that this reading of the image should be labelled as "DHO", and saves the results in an R data object file called "Scale_1_DHO.Rdata". Note that the radial measurements will be recorded as proportions of the image scale (i.e., 0 to 1) because no magnification was given or scale bar was processed.

```{r eval=FALSE}
fn <- collectRadiiData("Scale_1.png",ID="1",reading="DHO")
```

As this process requires interactive input from the user it is not shown in this static vignette. It should be noted, however, that reminders for the user are printed in the console at each step of the process.

Given the number of tasks required of `collectRadiiData()` it has many arguments. These are discussed in detail below.

### The Basics
The first five arguments to `collectRadiiData()` are related to information about the structure. The first argument is the image file name, which must be fully pathed if the image file is not in the current working directory. If this argument is not supplied then a dialog box will be provided from which the file can be selected. A unique identifier for the fish/structure **must** be given in `ID=` and a unique label for the readings (used when the structure is read more than once) **must** be given in `reading=`.

The R data object that will ultimately be created by `collectRadiiData()` will have the same name as the image file (from the first argument described above) but with a suffix derived from the string in `reading=` and, *optionally*, any additional strings given in `suffix=`. For example, if the sructure image file was named "Scale_1.png" then the resultant R data object file will be named "Scale_1_DHO.Rdata" if `reading="DHO"` or "Scale_1_A_DHO.Rdata" if `reading="A"` and `suffix="DHO"`.

The user may *optionally* provide more description for the structure in `description=`, which will be saved in the R data file object. For example, one may use `description="Cisco scale read once by Ogle on 22-Apr-18"` to provide more information about the structure reading.

By default, `collectRadiiData()` opens each image file in a separate window. The use of the separate window is especially useful if you are working on a system with two monitors (you can have R/RStudio on one monitor and the window with the structure image on the other). This window is also configured so that if you resize the window the shape of the structure image (i.e., its aspect ratio) will not change.

### Setting the Scale on the Image
**Scale-bar On Image:** Several back-calculation methods (see [this vignette](backcalculation.html)) require estimating the relationship between fish and structure length. For those methods, the actual lengths of the structure and each radial measurement are required. Collection of actual lengths, rather than proportional lengths, requires a scaling factor that can convert measurements on the image to actual lengths of the structure. If a "scale bar" of known length exists on the image, then, in `collectRadiiData()`, use `scaleBar=TRUE` and give the actual length of the scale bar to `scaleBarLength=`. You will then be prompted to select the two end points of the scale bar on the structure image. An appropriate scaling factor will then be computed from your selections and the radial measurements will be converted to the actual scale (see further below).

**Separately Define Scaling Factor:** In some applications it may not be possible to obtain an image with a scale bar. In these instances the user may capture the image at a selected magnification of the microscope and then capture an image of an object of known length at that same magnification. A scaling factor may then be computed from the image with the object of known length and applied to the structure image. Once this scaling factor is known, it can be given to `scalingFactor=` in `collectRadiiData()`.

The `findScalingFactor()` function can be used to load the image that contains an object of known length on which the two end points of the image can be selected. The value returned from this function is the scaling factor for `scalingFactor=` in `collectRadiiData()`. The `findScalingFactor()` function requires the name of the image with the object of known length as the first argument (if no name is given then you will be asked to browse to the iage) and the known length of the object in `knownLength=`.

If no `scalingFactor=` is given or derived from a scale bar then the radial measurements returned by `collectRadiiData()` are simply proportional to the unknown actual lengths on the structure.


### Adding a Transect to the Image (Optional)
A linear transect may be added to the image to provide a landmark on which the user will mark annuli. The user will be asked to add a transect by default, but this behavior can be turned off (e.g., the image already has a transect on it) with `addTransect=FALSE`. If not turned off, then the user will be prompted in the console window to add the transect to the image by clicking (with the first mouse button) on the structure focus and then on the structure margin. The linear transect will then be drawn between these two points. The color, width, and type of the transect can be modified with `col.transect=`, `lwd.transect=`, and `lty.transect=`, respectively.

### Selecting Annuli on the Image
Finally, the user will be asked to select points on the structure image that represent annuli. The point that represents the focus must be selected (with the first (left) mouse) first, followed successively by each annulus,[^2] and then the structure edge (if it is not an annulus). When the last point has been selected, the user must press the ESCape key in Windows or with Mac OS X (or right-click on the image and select STOP in Windows). The plotting character, color, and relative size of the selected points can be changed from the default settings with `pch.annuli=`, `col.annuli=`, and `cex.annuli=`.

It is important that the last point selected above is the structure margin because several back-calculation techniques require knowing the "structure size" at the time of capture. If the fish was captured during a growing season, the growth on the structure between the last annulus and the margin will not represent complete annual growth. To assure proper processing of the selected points, use `edgeIsAnnulus=TRUE` to identify that the margin of the structure is an annulus (i.e., annual growth completed) or `edgeIsAnnulus=FALSE` (the default) to identify that the margin of the structure is NOT an annulus.

\  

\  

----

# Examine Radii Data
### Data.frame of Radii
The result from the previous section is an R object data file in the current working directory. Among other things, this data file contains a data.frame of radial measurements to successive annuli. This data.frame can be extracted from the data file with `combineRadiiData()` using the name of the R object data file as the first argument. The name of the R object data file could be entered as string or be the object saved from `collectRadiiData()`. For example, both lines below would produce the same result (because `fn2` was saved from `collectRadiiData()` in the previous section).
```{r eval=FALSE}
df <- combineRadiiData("Scale_1_DHO.RData")
df <- combineRadiiData(fn)
```
```{r echo=FALSE}
## This loads the file from the external data folder
fn <- "Scale_1_DHO.RData"
load(fn)
df <- combineRadiiData(fn)
```
```{r}
df
```

The `combineRadiiData()` function is more interesting when considering multiple structures (see next section).

### View Annular Markings
One can review the markings on the structure with `showAnnuli()`, which only requires the name of an R data file object created with `combineRadiiData()` as the first object. This file name can be typed as a string, given as the name of an object returned from `combineRadiiData()`, or, if nothing is given, a dialog box will appear from which the data file can be selected. The color, width, and type of the "transect" (actually, just a line connecting the first and last points) may be changed with `col.transect=`, `lwd.transect=`, and `lty.transect=`. The "transect" can be excluded with `showTransect=FALSE`. The plotting character, color, and relative size of the selected points may be changed with `pch.annuli=`, `col.annuli=`, and `cex.annuli=`.

```{r}
showAnnuli(fn)
```

\  

\  

----

# Examine Multiple Reads of the Same Structure
In some instances, one may be interested in visually comparing the selected points from multiple reads of the same structure. For example, the code below collects a second set of points for the "Scale_1.png" image (used in the first section above). Note the diffrent value in `reading=`.
```{r eval=FALSE}
collectRadiiData("Scale_1.png",ID="1",reading="DHO2")
```

As shown above, `showAnnuli()` can be used to overlay the selected points onto the structure image. A second set of points can be overlaid onto the active plot by including `add=TRUE` in a second call to `showAnnuli()` with a second R object data file constructed from the same image. For example, the first line of code below overlays the annuli from the first selections onto the image. The second line then overlays the annuli from the second selections onto this (because `add=TRUE`) and uses a different color for the transect and points.
```{r}
showAnnuli("Scale_1_DHO.RData")
showAnnuli("Scale_1_DHO2.RData",add=TRUE,
           col.transect="green",col.annuli="blue")
```

\  

\  

----

# Combine Data from Multiple Structures
### File Organization
Of course, most analyses will consist of collecting radial measurements from structures from many fish. In this section, I demonstrate how to combine measurements from multiple structures. This demonstration assumes that all structure image files of interest are in a single directory.

The `listFiles()` function can be used to identify all of the filenames in the current working directory that have a particular file extension, which is given as the first argument.
```{r}
( fns <- listFiles("png") )
```

### Processing Multiple Structure Images
The user would then cycle through each of these individual structure image files using the same process described in the first section above to collect the radii data from each structure. The only difference below is that the filename is extrated from the vector of filenames returned by `listFiles()` and the name of the saved R object data file is not saved (i.e., the value returned from `collectRadiiData()` was not assigned to an object as above).
```{r eval=FALSE}
collectRadiiData(fns[1],ID="1",reading="DHO2")
collectRadiiData(fns[2],ID="1",reading="DHO2")
```

### Combining Data Extracted from Multiple Structure Images
Once all structured image files have been processed, the radial measurements can be combined into one data.frame with `combineRadiiData()`. This function can take a first argument that is a vector of R object file names. The easiest way to construct that vector is to use `listFiles()` using the `.RData` extension (the extension used for R object file names).
```{r results='hide'}
( fns2 <- listFiles("RData") )
```
```{r echo=FALSE}
fns2 <- fns2[-2]
fns2
```
```{r}
dfrad <- combineRadiiData(fns2)
dfrad
```

### Preparing for Back-Calculations
Other information about the fish (e.g., location of capture, length, sex) is likely held in a separate file. Below, example "other" data are loaded into the `dffish` data.frame. Note that the `ID` and `reading` variables created from processing the image points are characters. In this case, `read.csv()` reads the `ID` variable from the external data file as a numeric (because the unique IDs were simple numbers). The second line of code converts these numeric IDs to characters so that this data.frame can be joined with the radial measurements data.frame from above.
```{r}
dffish <- read.csv("FishData.csv") %>%
  mutate(ID=as.character(ID)) %>% 
  inner_join(dfrad,by="ID")
dffish
```

\  

\  

----

# Footnotes

[^1]: See [Vigliola and Meekan (2009)](https://www.researchgate.net/publication/226394736_The_Back-Calculation_of_Fish_Growth_From_Otoliths) for background information.

[^2]: When the structure image is in the "Plots" pane of RStudio, the points will not be visible until after you have finished selecting all points.
